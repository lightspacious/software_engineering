{% extends "base.html" %}

{% block content %}
<style>
    /* 重置所有元素的margin和padding */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* 确保html和body元素占满整个视口 */
    html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    /* 主容器占满整个父元素 */
    .container {
        display: grid;
        grid-template-columns: 3fr 1fr; /* 左2/3，右1/3 */
        width: 100%;
        height: 100vh; /* 使用视口高度单位 */
        gap: 10px;
        padding: 10px;
    }

    .left-panel {
        display: grid;
        grid-template-rows: 7fr 4fr; /* 上下等分 */
        gap: 10px;
        height: 100%; /* 确保高度占满父容器 */
    }

    .left-top {
        display: grid;
        grid-template-columns: 3fr 4fr; /* 左右等分 */
        gap: 10px;
        height: 100%; /* 确保高度占满父容器 */
    }

    .module {
    background-color: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 5px;
    color: white;
    height: 100%; /* 确保高度占满父容器 */
    overflow: auto; /* 修改为 auto 以显示滚动条 */
}


    .module-title {
        text-align: center;
        color: #00c3ff;
        margin-bottom: 10px;
        font-size: 18px;
    }

    .right-panel {
    display: flex;
    flex-direction: column;
    gap: 10px;
    height: calc(100% - 20px); /* 减去 padding 和 gap 的影响 */
    padding: 10px 0; /* 只保留垂直方向的 padding */
}

.combined-module {
    background-color: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 5px;
    color: white;
    display: flex;
    flex-direction: column;
    height: 100%; /* 确保高度占满父容器 */
    overflow: auto; /* 修改为 auto 以显示滚动条 */
    flex: 1; /* 确保模块填满可用空间 */
    min-height: 0; /* 允许内容被压缩 */
}

/*地图容器大小 begin*/
    #map-container {
        width: 495px;
        height: 310px;
        /* left:-10px; */
    }
/* 地图 end */
</style>

<!-- 地图数据 begin-->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- 地图数据 end -->
<div class="container">
    <!-- 左侧大面板 -->
    <div class="left-panel">
        <!-- 左上小面板，分为左右两部分 -->
        <div class="left-top">
            <!-- 模块A1 -->
            <div class="module">
                <div class="module-title">硬件信息统计</div>
                <p>内容区域 A1</p>
            </div>
            <!-- 模块A2 -->
            <div class="module">
                <div class="module-title">数据中心分布</div>
                <!-- <p>内容区域 A2</p> -->
                <!-- 地图 -->
                <div id="map-container"></div>
            </div>
        </div>
        <!-- 左下模块B -->
        <div class="module">
            <div class="module-title">数据类型统计</div>
            <p>内容区域 B</p>
        </div>
    </div>

    <!-- 右侧小面板 -->
    <div class="right-panel">
        <!-- 模块C -->
        <div class="combined-module">
            <div class="module-title">传感器信息+数据库交互统计</div>
            <p>内容区域 C</p>
        </div>
    </div>
</div>

<!-- 地图part绘制 -->
<script>
    fetch('https://geo.datav.aliyun.com/areas/bound/geojson?code=100000_full')
        .then(res => res.json())
        .then(geoJson => {
            echarts.registerMap('china', geoJson);
            var myChart = echarts.init(document.getElementById('map-container'));

            var points = [
                {
                    name: '杭州',
                    value: [120.15, 30.28, parseFloat((30+ Math.random() * 4 - 2).toFixed(2))],
                    provider: '阿里云',
                    info: '数据中心',
                    itemStyle: {
                        color: '#00FF99'  // 红色
                    }
                },
                {
                    name: '北京',
                    value: [116.46, 39.92, parseFloat((25 + Math.random() * 4 - 2).toFixed(2))],
                    provider: '百度云',
                    info: '北方节点',
                    itemStyle: {
                        color: '#FFC300'  // 红色
                    }
                },
                {
                    name: '广州',
                    value: [113.23, 23.16, parseFloat((20+ Math.random() * 4 - 2).toFixed(2))],
                    provider: '腾讯云',
                    info: '南方节点',
                    itemStyle: {
                        color: '#D966FF'  
                    }
                },
                {
                    name: '重庆',
                    value: [106.55, 29.57, parseFloat((22 + Math.random() * 4 - 2).toFixed(2))],  
                    provider: '华为云',
                    info: '西南节点',
                    itemStyle: {
                        color: ' #FF3366' 
                    }
                }
            ];

            var defaultPoint = points[0];
            var infoText = `数据中心\n地点：${defaultPoint.name}\n服务商：${defaultPoint.provider}\n连接：${defaultPoint.value[2]}ms`;          

            var option = {
                    tooltip: {
                        trigger: 'item',
                        show: false
                    },
                    
                    geo: {
                        map: 'china',
                        roam: false,
                        zoom: 1.63,
                        center: [113.6, 35.0],
                        label: {
                            show: false,
                            
                        },
                        itemStyle: {//边界线
                            areaColor: 'transparent',   
                            borderColor: '#39A7FF',     
                            borderWidth: 1              
                        },
                        emphasis: {
                            label: {
                                show: false,
                            },
                            itemStyle: {
                                areaColor: 'transparent'
                            }
                        }
                    },
                    
                    series: [
                        {
                            name: '城市',
                            type: 'scatter',
                            coordinateSystem: 'geo',
                            data: points,
                            // symbol: 'pin',
                            symbol: 'path://M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z', 
                            // symbolSize: function (val) {
                            //     return val[2] ;
                            // },
                            symbolSize: function(val) {
                                return [val[2] * 0.75, val[2]];  // 宽度是高度的60%
                            },
                            symbolKeepAspect: false,
                            label: {
                                formatter: '{b}',
                                position: 'right',
                                show: false,
                                fontSize: 10,         
                                color: '#ffffff'     
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 20,
                                    color:'#ffffff'
                                }
                            }
                        },
                        {
                            name: '连接线',
                            type: 'lines',
                            coordinateSystem: 'geo',
                            zlevel: 2,
                            effect: {
                                show: true,
                                period: 6,
                                trailLength: 0.2,
                                color: '#fff',
                                symbol: 'arrow',
                                symbolSize: 6
                            },
                            lineStyle: {
                                color: '#00FFFF',
                                width: 1,
                                opacity: 0.6,
                                curveness: 0.2
                            },
                            data: [
                                {
                                    coords: [points[1].value, points[0].value] 
                                },
                                {
                                    coords: [points[3].value, points[0].value]  
                                },
                                {
                                    coords: [points[3].value, points[1].value]  
                                },
                                {
                                    coords: [points[3].value, points[2].value]  
                                }
                            ]
                        }
                    ],         

                    graphic: [
                            {
                                type: 'group',     
                                id: 'infoCard',  
                                left: '65%',       
                                top: '37%',     
                                children: [     
                                {
                                    type: 'rect', 
                                    z: 100,     
                                    left: -90,
                                    top:-5,
                                    shape: { width: 170, height: 100 }, 
                                    style: {
                                        fill: 'rgba(11, 61, 145, 0.85)',  
                                        stroke: '#39A7FF',               
                                        lineWidth: 1,                    
                                        shadowBlur: 10,               
                                        shadowColor: '#000'             
                                    }
                                },
                                {
                                    id: 'infoText',   
                                    type: 'text',      
                                    // left: 'center',
                                    left:-80,
                                    z: 200,   
                                    style: {
                                        text:infoText,
                                        font: '14px Microsoft YaHei',
                                        lineHeight: 21,
                                        // align: 'center',
                                        fill: '#E6F7FF',
                                        stroke: '#39A7FF',
                                        lineWidth: 0.3
                                        // shadowBlur: 15,
                                        // shadowColor: 'rgba(0, 255, 255, 0.6)',
                                        
                                
                                }
                                }
                                ]
                            }
                            ]
                };

            myChart.setOption(option);

            function updateValue() {

                defaultPoint.value[2] = parseFloat((point.value[2] + (Math.random() * 4 - 2)).toFixed(2));

                infoText = `数据中心\n地点：${defaultPoint.name}\n服务商：${defaultPoint.provider}\n连接：${defaultPoint.value[2]}ms`;
                        
                myChart.setOption({
                    graphic: {
                        elements: [
                            {
                                id: 'infoText',
                                type: 'text',      
                                // left: 'center', 
                                left:-80,
                                style: {
                                    text: infoText,
                                    font: '14px Microsoft YaHei',
                                    lineHeight: 21,
                                    fill: '#E6F7FF',
                                    stroke: '#39A7FF',
                                    lineWidth: 0.3,
                                }
                            }
                        ]
                    }
                });
            }       

            // 启动定时器
            // console.log("kaishi一次完成");
            setInterval(updateValue, 10000);
            // console.log("执行一次完成");
            

            myChart.on('click', function (params) {
                    if (params.seriesType === 'scatter') {
                        defaultPoint = params.data;
                        infoText = `数据中心\n地点：${defaultPoint.name}\n服务商：${defaultPoint.provider}\n连接：${defaultPoint.value[2]}ms`;
                        
                        myChart.setOption({
                            graphic: {
                                elements: [
                                    {
                                        id: 'infoText',
                                        type: 'text',      
                                        // left: 'center', 
                                        left:-80,
                                        style: {
                                            text: infoText,
                                            font: '14px Microsoft YaHei',
                                            lineHeight: 21,
                                            fill: '#E6F7FF',
                                            stroke: '#39A7FF',
                                            lineWidth: 0.3,
                                        }
                                    }
                                ]
                            }
                        });
                    }
            });

            window.addEventListener('resize', function() {
                    myChart.resize();
                });
        
        });
</script>
{% endblock %}